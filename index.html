<html>
<head>
<title>Convert a picture to Lego</title>
<meta charset="utf-8">

<script src="palette.js"></script>
<script src="color.js"></script>
<script src="palettes/palette-lego2016.js"></script>
<script src="palettes/palette-lego2016grays.js"></script>
<script src="palettes/palette-legopickabrickplates.js"></script>
<script src="palettes/palette-legopickabrickbricks.js"></script>
<script src="palettes/palette-peeron.js"></script>
<script src="palettes/palette-mono.js"></script>
<script src="palettes/palette-3bitcolor.js"></script>
<script src="palettes/palette-2bitgray.js"></script>
<script src="palettes/palette-4bitgray.js"></script>
<script src="palettes/palette-8bitgray.js"></script>
<script src="palettes/palette-4bitcolormac.js"></script>
<script src="palettes/palette-websafe.js"></script>
<script src="legodither.js"></script>
<script src="imageinfo.js"></script>
<script src="imageadjust.js"></script>
<script src="colorutil.js"></script>
<script src="quantization.js"></script>
<script src="scaling.js"></script>
<script src="bom.js"></script>
<script src="brick.js"></script>
<script src="drawbricks.js"></script>
<script src="editor.js"></script>
<script src="testbom.js"></script>
<script src="testscaling.js"></script>
<link rel="stylesheet" type="text/css" href="legodither.css">

</head>
<body onload="runScalingTests()">

    <form>
        <input type="file" accept="image/*" id="inputImg" onchange="loadFile(event, 'original')">
        <!-- Adapted from https://stackoverflow.com/questions/4459379/preview-an-image-before-it-is-uploaded -->
        <script>
            const maxWidth = 500;
            const loadFile = function(event, targetID) {
                let original = document.getElementById(targetID);
                original.src = URL.createObjectURL(event.target.files[0]);
                original.onload = function() {
                    URL.revokeObjectURL(original.src); // free memory

                    // Load original into full-sized offscreen canvas
                    let canvas = document.getElementById("originalCanvas");
                    canvas.setAttribute("width", this.width);
                    canvas.setAttribute("height", this.height);
                    let context = canvas.getContext('2d');
                    context.drawImage(original, 0, 0, this.width, this.height, 0, 0, this.width, this.height);

                    // Scale original for display
                    let scaledOrigCanvas = document.getElementById("scaledOrigCanvas");
                    let width = (this.width < maxWidth ? this.width : maxWidth);
                    let height = this.height * (width / this.width);
                    scaledOrigCanvas.setAttribute("width", width);
                    scaledOrigCanvas.setAttribute("height", height);

                    let scaledOrigContext = scaledOrigCanvas.getContext('2d');
                    scaledOrigContext.drawImage(original, 0, 0, this.width, this.height, 0, 0, width, height);
                    updateSize(0, 128, 0);

                    //updateKernel();
                    resetLevels();
                    drawLego();
                }
            };
        </script>
        <label for="scaleInput">Shrink factor:</label>
        <input type="number" id="scaleInput" min="1" max="64" value="2" step="0.1" onchange="updateSize(this.value, 0, 0); drawLego()">

        <input type="number" id="outputWidth" min="1" max="500" value="150" step="1" onchange="updateSize(0, this.value, 0); drawLego()">
        <input type="number" id="outputHeight" min="1" max="500" value="75"  step="1" onchange="updateSize(0, 0, this.value); drawLego()">

        <label for="resizeSelect">Resizing Filter:</label>
        <select id="resizeSelect" onchange="drawLego()">
            <option value="box" selected="true">Box filter</option>
            <option value="nearestNeighbor">Nearest neighbor</option>
            <option value="bilinear">Bilinear</option>
            <option value="dpid">Detail-preserving (DPID)</option>
        </select>

        <label for="paletteSelect">Palette:</label>
        <select id="paletteSelect" onchange="drawLego()">
            <option value="lego2016">LEGO 2016 palette</option>
            <option value="lego2016grays">LEGO 2016 palette (grays only)</option>
            <option value="legoPABplates" selected="true">LEGO Pick-A-Brick 1x1 plates</option>
            <option value="legoPABbricks">LEGO Pick-A-Brick 1x1 bricks</option>
            <option value="peeron">LEGO palette (Peeron)</option>
            <option value="void" disabled>--------</option>
            <option value="mono">Black + White</option>
            <option value="2bitgray">4 grays</option>
            <option value="4bitgray">16 grays</option>
            <option value="8bitgray">256 grays</option>
            <option value="void" disabled>--------</option>
            <option value="3bitcolor">8 colors</option>
            <option value="4bitcolormac">16 colors (Mac Palette)</option>
            <option value="websafe">216 websafe colors</option>
            <option value="native">Native color (no quantization)</option>
        </select>

        <label for="ditheringSelect">Color dithering:</label>
        <select id="ditheringSelect" onchange="drawLego()">
            <option value="none">None</option>
            <option value="floyd-steinberg" selected="true">Floyd-Steinberg</option>
            <option value="ordered">Ordered</option>
        </select>

        <br>

        <label for="inputLevelsShadowInput">Input level (shadow):</label>
        <input type="range" id="inputLevelsShadowInput" min="0" max="1" step="any" oninput="drawLego()">

        <label for="inputLevelsMidpointInput">Input level (midpoint):</label>
        <input type="range" id="inputLevelsMidpointInput" min="0" max="1" step="any" oninput="drawLego()">

        <label for="inputLevelsHighlightInput">Input level (highlight):</label>
        <input type="range" id="inputLevelsHighlightInput" min="0" max="1" step="any" oninput="drawLego()">

        <br>

        <label for="outputLevelsShadowInput">Output level (shadow):</label>
        <input type="range" id="outputLevelsShadowInput" min="0" max="1" step="any" oninput="drawLego()">

        <label for="outputLevelsHighlightInput">Output level (highlight):</label>
        <input type="range" id="outputLevelsHighlightInput" min="0" max="1" step="any" oninput="drawLego()">

        <input type="button" name="resetLevelsBtn" value="Reset levels" onclick="resetLevels(); drawLego()">
        <input type="button" name="autoLevelsBtn" value="Auto levels" onclick="autoLevels(); drawLego()">

        <label for="sharpInput">Sharpen factor:</label>
        <input type="number" id="sharpenInput" min="0" max="32" value="2" step="0.1" onchange="drawLego()">

        <br>

        <label for="brightnessInput">Brightness:</label>
        <input type="range" id="brightnessInput" min="-256" max="255" value="0" step="1" oninput="drawLego()">
        <input type="button" name="resetBrightnessBtn" value="Reset brightness" onclick="resetBrightness(); drawLego()">

        <label for="saturationInput">Saturation:</label>
        <input type="range" id="saturationInput" min="0" max="8" value="1" step="any" oninput="drawLego()">
        <input type="button" name="resetSaturationBtn" value="Reset saturation" onclick="resetSaturation(); drawLego()">

        <label for="saturationInput">Contrast:</label>
        <input type="range" id="contrastInput" min="-255" max="255" value="0" step="1" oninput="drawLego()">
        <input type="button" name="resetContrastBtn" value="Reset contrast" onclick="resetContrast(); drawLego()">

        <!--
        <div id="convolutionKernelContainer">
            <label for="convolution0">Convolution kernel:</label>
            <select id="convolutionSelect" onchange="updateKernel(); drawLego();">
                <option value="identity" selected="true">Identity kernel</option>
                <option value="lowpass">Low-pass</option>
                <option value="highpass">High-pass</option>
                <option value="3x3gaussian">3x3 Gaussian</option>
            </select>
            <table id="convolutionKernelTable">
                <tr>
                    <td><input type="text" id="convolution0" size="8" onchange="drawLego()"></td>
                    <td><input type="text" id="convolution1" size="8" onchange="drawLego()"></td>
                    <td><input type="text" id="convolution2" size="8" onchange="drawLego()"></td>
                </tr>
                <tr>
                    <td><input type="text" id="convolution3" size="8" onchange="drawLego()"></td>
                    <td><input type="text" id="convolution4" size="8" onchange="drawLego()"></td>
                    <td><input type="text" id="convolution5" size="8" onchange="drawLego()"></td>
                </tr>
                <tr>
                    <td><input type="text" id="convolution6" size="8" onchange="drawLego()"></td>
                    <td><input type="text" id="convolution7" size="8" onchange="drawLego()"></td>
                    <td><input type="text" id="convolution8" size="8" onchange="drawLego()"></td>
                </tr>
            </table>
        </div>
        -->
    </form>
    <div class="container">
        <div class="imgholder">
            <p>Original image</p>
            <p>Size in bricks: <span id="origWidthBricks"></span> wide x 
                <span id="origHeightBricks"></span> high (<span id="origTotalBricks"></span> total)</p>
            <p>Size in mm: <span id="origWidthMM"></span> x 
                <span id="origHeightMM"></span></p>
            <p>Size in inches: <span id="origWidthInch"></span>" wide x 
                <span id="origHeightInch"></span>" high</p>
    
            <img id="original" src="#" style="display: none">
            <canvas id="scaledOrigCanvas"></canvas>
        </div>

        <div class="imgholder">
            <p>Transformed image w/ LEGO palette</p>
            <p>Size in bricks: <span id="legoWidthBricks"></span> wide x 
                <span id="legoHeightBricks"></span> high (<span id="legoTotalBricks"></span> total)</p>
            <p>Size in mm: <span id="legoWidthMM"></span>mm wide x 
                <span id="legoHeightMM"></span>mm high</p>
            <p>Size in inches: <span id="legoWidthInch"></span>" wide x 
                <span id="legoHeightInch"></span>" high</p>
    
            <canvas id="legoCanvas"></canvas>
        </div>

        <div class="palette-container">
            <p>Palette</p>
            <input type="button" name="enableAllPaletteBtn" value="Enable All Colors" onclick="enableAllColors()">
            <div id="palette-wrapper"><div id="palette-dummy"></div></div>
        </div>

        <div class="coord-container">
            x=<span id="outputXCoord"></span>
            y=<span id="outputYCoord"></span>
            brick=<span id="outputBrickCoords"></span>
        </div>

        <div class="pen-container">
            <p>Pen color</p>
            <div id="pencolor-wrapper"><div id="pencolor-dummy"></div></div>
        </div>

        <div class="scratch">
            <p>Scratch</p>
            <canvas id="originalCanvas"></canvas>
            <canvas id="scratchACanvas"></canvas>
            <canvas id="scratchBCanvas"></canvas>
        </div>
    </div>

    <div class="bom-container">
        <label for="findRectsSelect">BOM generation:</label>
        <select id="findRectsSelect" onchange="drawBricksAndBOM()">
            <option value="singlePixels" selected="true">Only 1x1s</option>
            <option value="singleLine">Single-line (1D)</option>
            <option value="multiLine">Multi-line (2D)</option>
            <option value="expandingRects">Expanding rectangles (2D)</option>
            <option value="lowCPSFirst">Lowest cost-per-stud bricks first (2D)</option>
        </select>
        <p>Bill of Materials</p>
        <div class="bom">
            <p>Total cost: <span id="bomTotalCost"></span></p>
            <p>Total bricks: <span id="bomTotalBrickCount"></span></p>
            <p>Bricks: </p>
            <div id="brickList"><div class="dummy"></div>
        </div>
    </div>

    <div class="instruction-container">
        <canvas id="instructionCanvas"></canvas>
    </div>
</body>
</html>
